{% extends "base.html" %}

{% block title %}å­¦ä¹ è¿›åº¦ - CS146S åœ¨çº¿å­¦ä¹ å¹³å°{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">å­¦ä¹ ä»ªè¡¨æ¿</a></li>
                <li class="breadcrumb-item active">å­¦ä¹ è¿›åº¦</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-chart-line"></i> å­¦ä¹ è¿›åº¦åˆ†æ</h2>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary active" onclick="setTimeRange('week')">
                    æœ¬å‘¨
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="setTimeRange('month')">
                    æœ¬æœˆ
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="setTimeRange('all')">
                    å…¨éƒ¨
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ€»ä½“ç»Ÿè®¡å¡ç‰‡ -->
<div class="row mb-4" id="statsCards">
    <!-- ç»Ÿè®¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
</div>

<!-- è¿›åº¦å›¾è¡¨ -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-area"></i> å­¦ä¹ è¿›åº¦è¶‹åŠ¿</h5>
            </div>
            <div class="card-body">
                <canvas id="progressTrendChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-trophy"></i> æˆå°±å¾½ç« </h5>
            </div>
            <div class="card-body" id="achievementsList">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½æˆå°±ä¸­...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¯¦ç»†åˆ†æ -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-check"></i> æ¯å‘¨è¡¨ç°</h5>
            </div>
            <div class="card-body">
                <canvas id="weeklyPerformanceChart" width="400" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> å­¦ä¹ æ—¶é—´åˆ†å¸ƒ</h5>
            </div>
            <div class="card-body">
                <canvas id="timeDistributionChart" width="400" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ç»ƒä¹ åˆ†æ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-code"></i> ç»ƒä¹ å®Œæˆæƒ…å†µ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="exerciseCompletionChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div id="exerciseStats">
                            <!-- ç»ƒä¹ ç»Ÿè®¡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å­¦ä¹ ä¹ æƒ¯åˆ†æ -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-alt"></i> å­¦ä¹ æ—¥å†</h5>
            </div>
            <div class="card-body">
                <div id="learningCalendar" class="text-center">
                    <div class="text-muted mb-3">
                        <i class="fas fa-calendar fa-2x"></i>
                    </div>
                    <p>æ˜¾ç¤ºæ‚¨æœ€è¿‘30å¤©çš„å­¦ä¹ æ´»åŠ¨</p>
                    <div id="calendarGrid" class="d-flex flex-wrap justify-content-center gap-1">
                        <!-- æ—¥å†ç½‘æ ¼å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb"></i> å­¦ä¹ æ´å¯Ÿ</h5>
            </div>
            <div class="card-body" id="learningInsights">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin"></i> åˆ†æå­¦ä¹ æ•°æ®ä¸­...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ’è¡Œæ¦œ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-crown"></i> æ’è¡Œæ¦œ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>æ€»ç§¯åˆ†æ’è¡Œ</h6>
                        <div id="leaderboardOverall" class="leaderboard-list">
                            <!-- æ’è¡Œæ¦œå°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>æœ¬å‘¨æ’è¡Œ</h6>
                        <div id="leaderboardWeekly" class="leaderboard-list">
                            <!-- å‘¨æ’è¡Œæ¦œå°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<style>
.stats-card {
    transition: transform 0.2s ease;
}

.stats-card:hover {
    transform: translateY(-2px);
}

.achievement-badge {
    display: inline-block;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0.5rem;
    font-size: 1.5rem;
    transition: transform 0.2s ease;
}

.achievement-badge:hover {
    transform: scale(1.1);
}

.achievement-earned {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #856404;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
}

.achievement-locked {
    background: #e9ecef;
    color: #6c757d;
    opacity: 0.6;
}

.calendar-day {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    margin: 1px;
}

.calendar-day.active {
    background: #007bff;
    color: white;
}

.calendar-day.inactive {
    background: #e9ecef;
}

.leaderboard-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
    transition: background-color 0.2s ease;
}

.leaderboard-item:hover {
    background: #f8f9fa;
}

.leaderboard-item.current-user {
    background: #e7f3ff;
    border-left: 3px solid #007bff;
}

.rank-badge {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 1rem;
}

.rank-1 { background: #ffd700; color: #856404; }
.rank-2 { background: #c0c0c0; color: #495057; }
.rank-3 { background: #cd7f32; color: white; }
.rank-other { background: #6c757d; color: white; }

.insight-card {
    background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 123, 255, 0.05));
    border-left: 4px solid #007bff;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 0.375rem;
}
</style>

<script>
let currentTimeRange = 'week';
let progressData = null;
let statsData = null;

// Chart instances
let progressTrendChart = null;
let weeklyPerformanceChart = null;
let timeDistributionChart = null;
let exerciseCompletionChart = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadProgressData();
});

// è®¾ç½®æ—¶é—´èŒƒå›´
function setTimeRange(range) {
    currentTimeRange = range;

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });

    document.querySelector(`[onclick="setTimeRange('${range}')"]`).classList.add('active');

    // é‡æ–°åŠ è½½æ•°æ®
    loadProgressData();
}

// åŠ è½½è¿›åº¦æ•°æ®
function loadProgressData() {
    Promise.all([
        fetch('/api/v1/learning/progress').then(r => r.json()),
        fetch('/api/v1/learning/stats').then(r => r.json()),
        fetch('/api/v1/learning/leaderboard').then(r => r.json())
    ])
    .then(([progress, stats, leaderboard]) => {
        if (progress.success && stats.success && leaderboard.success) {
            progressData = progress.progress;
            statsData = stats;

            renderStatsCards(stats);
            renderProgressCharts(progress.progress, stats);
            renderAchievements(stats);
            renderLearningCalendar(stats);
            renderLearningInsights(progress.progress, stats);
            renderLeaderboards(leaderboard.leaderboard);
        }
    })
    .catch(error => {
        console.error('åŠ è½½è¿›åº¦æ•°æ®å¤±è´¥:', error);
        showError('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    });
}

// æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
function renderStatsCards(stats) {
    const container = document.getElementById('statsCards');

    const cards = [
        {
            icon: 'fas fa-code',
            title: 'ç»ƒä¹ å®Œæˆ',
            value: stats.completed_exercises,
            subtitle: `å…± ${stats.total_exercises} é¢˜`,
            color: 'primary',
            progress: (stats.completed_exercises / stats.total_exercises * 100)
        },
        {
            icon: 'fas fa-trophy',
            title: 'æ€»ç§¯åˆ†',
            value: Math.round(stats.total_score),
            subtitle: `å¹³å‡ ${Math.round(stats.average_score)} åˆ†`,
            color: 'success'
        },
        {
            icon: 'fas fa-clock',
            title: 'å­¦ä¹ æ—¶é•¿',
            value: Math.round(stats.total_time_spent / 3600) + 'h',
            subtitle: `æœ¬å‘¨ ${Math.round(stats.weekly_submissions)} æ¬¡æäº¤`,
            color: 'info'
        },
        {
            icon: 'fas fa-fire',
            title: 'è¿ç»­å­¦ä¹ ',
            value: stats.streak_days + ' å¤©',
            subtitle: `æ­£ç¡®ç‡ ${Math.round(stats.accuracy_rate)}%`,
            color: 'warning'
        }
    ];

    const cardsHtml = cards.map(card => `
        <div class="col-md-3 mb-3">
            <div class="card stats-card border-${card.color}">
                <div class="card-body text-center">
                    <i class="fas ${card.icon} fa-2x text-${card.color} mb-2"></i>
                    <h5 class="text-${card.color}">${card.value}</h5>
                    <p class="mb-1">${card.title}</p>
                    <small class="text-muted">${card.subtitle}</small>
                    ${card.progress !== undefined ? `
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar bg-${card.color}" style="width: ${card.progress}%"></div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');

    container.innerHTML = cardsHtml;
}

// æ¸²æŸ“è¿›åº¦å›¾è¡¨
function renderProgressCharts(progress, stats) {
    renderProgressTrendChart(progress);
    renderWeeklyPerformanceChart(progress);
    renderTimeDistributionChart(stats);
    renderExerciseCompletionChart(progress, stats);
}

// æ¸²æŸ“è¿›åº¦è¶‹åŠ¿å›¾
function renderProgressTrendChart(progress) {
    const ctx = document.getElementById('progressTrendChart').getContext('2d');

    const labels = progress.weeks.map(w => `Week ${w.week_number}`);
    const data = progress.weeks.map(w => w.progress_percentage);

    if (progressTrendChart) {
        progressTrendChart.destroy();
    }

    progressTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'å­¦ä¹ è¿›åº¦ (%)',
                data: data,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// æ¸²æŸ“æ¯å‘¨è¡¨ç°å›¾
function renderWeeklyPerformanceChart(progress) {
    const ctx = document.getElementById('weeklyPerformanceChart').getContext('2d');

    const data = progress.weeks.map(w => ({
        week: `Week ${w.week_number}`,
        completed: w.completed_exercises,
        total: w.total_exercises,
        score: w.completed_exercises > 0 ? Math.round(
            progress.weeks.find(p => p.week_id === w.week_id)?.time_spent || 0
        ) : 0
    }));

    if (weeklyPerformanceChart) {
        weeklyPerformanceChart.destroy();
    }

    weeklyPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.week),
            datasets: [{
                label: 'å®Œæˆç»ƒä¹ æ•°',
                data: data.map(d => d.completed),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// æ¸²æŸ“æ—¶é—´åˆ†å¸ƒå›¾
function renderTimeDistributionChart(stats) {
    const ctx = document.getElementById('timeDistributionChart').getContext('2d');

    // æ¨¡æ‹Ÿæ—¶é—´åˆ†å¸ƒæ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦ä»åç«¯è·å–ï¼‰
    const timeData = {
        labels: ['æ—©æ™¨ (6-12)', 'ä¸‹åˆ (12-18)', 'æ™šä¸Š (18-24)', 'æ·±å¤œ (0-6)'],
        data: [25, 35, 30, 10] // ç™¾åˆ†æ¯”
    };

    if (timeDistributionChart) {
        timeDistributionChart.destroy();
    }

    timeDistributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: timeData.labels,
            datasets: [{
                data: timeData.data,
                backgroundColor: [
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 99, 132, 0.6)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// æ¸²æŸ“ç»ƒä¹ å®Œæˆå›¾
function renderExerciseCompletionChart(progress, stats) {
    const ctx = document.getElementById('exerciseCompletionChart').getContext('2d');

    const completed = stats.completed_exercises;
    const total = stats.total_exercises;
    const remaining = total - completed;

    if (exerciseCompletionChart) {
        exerciseCompletionChart.destroy();
    }

    exerciseCompletionChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['å·²å®Œæˆ', 'å¾…å®Œæˆ'],
            datasets: [{
                data: [completed, remaining],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.6)',
                    'rgba(108, 117, 125, 0.6)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // æ›´æ–°ç»ƒä¹ ç»Ÿè®¡
    const statsHtml = `
        <h6>ç»ƒä¹ ç»Ÿè®¡</h6>
        <div class="mb-2">
            <strong>å·²å®Œæˆ:</strong> ${completed} / ${total}
        </div>
        <div class="mb-2">
            <strong>æ­£ç¡®ç‡:</strong> ${Math.round(stats.accuracy_rate)}%
        </div>
        <div class="mb-2">
            <strong>å¹³å‡å¾—åˆ†:</strong> ${Math.round(stats.average_score)}
        </div>
        <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-success" style="width: ${(completed/total*100)}%"></div>
        </div>
    `;

    document.getElementById('exerciseStats').innerHTML = statsHtml;
}

// æ¸²æŸ“æˆå°±å¾½ç« 
function renderAchievements(stats) {
    const container = document.getElementById('achievementsList');

    const achievements = [
        {
            id: 'first_exercise',
            icon: 'ğŸ†',
            title: 'åˆå­¦è€…',
            description: 'å®Œæˆç¬¬ä¸€ä¸ªç»ƒä¹ ',
            earned: stats.total_submissions > 0
        },
        {
            id: 'ten_exercises',
            icon: 'ğŸ¯',
            title: 'ç›®æ ‡è¾¾äºº',
            description: 'å®Œæˆ10ä¸ªç»ƒä¹ ',
            earned: stats.completed_exercises >= 10
        },
        {
            id: 'perfect_score',
            icon: 'ğŸ’',
            title: 'å®Œç¾ä¸»ä¹‰è€…',
            description: 'è·å¾—100åˆ†',
            earned: stats.total_score >= 100
        },
        {
            id: 'streak_master',
            icon: 'ğŸ”¥',
            title: 'åšæŒå¤§å¸ˆ',
            description: 'è¿ç»­å­¦ä¹ 7å¤©',
            earned: stats.streak_days >= 7
        },
        {
            id: 'speed_demon',
            icon: 'âš¡',
            title: 'é€Ÿåº¦ä¹‹æ˜Ÿ',
            description: 'å•é¢˜ç”¨æ—¶å°‘äº2åˆ†é’Ÿ',
            earned: false // éœ€è¦å…·ä½“å®ç°
        },
        {
            id: 'help_seeker',
            icon: 'ğŸ¤–',
            title: 'AIåŠ©æ‰‹ç”¨æˆ·',
            description: 'ä½¿ç”¨AIåŠ©æ‰‹10æ¬¡',
            earned: false // éœ€è¦è·Ÿè¸ªAIä½¿ç”¨æ¬¡æ•°
        }
    ];

    const achievementsHtml = achievements.map(achievement => `
        <div class="text-center d-inline-block">
            <div class="achievement-badge ${achievement.earned ? 'achievement-earned' : 'achievement-locked'}"
                 title="${achievement.title}: ${achievement.description}">
                ${achievement.icon}
            </div>
            <small class="d-block mt-1 ${achievement.earned ? 'text-success' : 'text-muted'}">
                ${achievement.title}
            </small>
        </div>
    `).join('');

    container.innerHTML = achievementsHtml;
}

// æ¸²æŸ“å­¦ä¹ æ—¥å†
function renderLearningCalendar(stats) {
    const container = document.getElementById('calendarGrid');

    // ç”Ÿæˆæœ€è¿‘30å¤©çš„æ—¥å†
    const days = [];
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);

        // æ¨¡æ‹Ÿå­¦ä¹ æ´»åŠ¨ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦ä»åç«¯è·å–ï¼‰
        const hasActivity = Math.random() > 0.3; // 70%çš„æ¦‚ç‡æœ‰å­¦ä¹ æ´»åŠ¨

        days.push({
            date: date,
            hasActivity: hasActivity,
            day: date.getDate()
        });
    }

    const calendarHtml = days.map(day => `
        <div class="calendar-day ${day.hasActivity ? 'active' : 'inactive'}"
             title="${day.date.toLocaleDateString()}">
            ${day.day}
        </div>
    `).join('');

    container.innerHTML = calendarHtml;
}

// æ¸²æŸ“å­¦ä¹ æ´å¯Ÿ
function renderLearningInsights(progress, stats) {
    const container = document.getElementById('learningInsights');

    const insights = [];

    // åŸºäºæ•°æ®ç”Ÿæˆæ´å¯Ÿ
    if (stats.streak_days === 0) {
        insights.push({
            type: 'warning',
            icon: 'fas fa-exclamation-triangle',
            title: 'å­¦ä¹ è¿ç»­æ€§',
            message: 'ä¿æŒæ¯æ—¥å­¦ä¹ å¯ä»¥å¸®åŠ©æ‚¨æ›´å¥½åœ°æŒæ¡çŸ¥è¯†ã€‚å°è¯•è®¾ç½®å­¦ä¹ æé†’ã€‚'
        });
    }

    if (stats.accuracy_rate < 70) {
        insights.push({
            type: 'info',
            icon: 'fas fa-lightbulb',
            title: 'æé«˜å‡†ç¡®ç‡',
            message: 'æ‚¨çš„æ­£ç¡®ç‡å¯ä»¥è¿›ä¸€æ­¥æå‡ã€‚å¤šé˜…è¯»é¢˜ç›®è¦æ±‚ï¼Œä½¿ç”¨AIåŠ©æ‰‹è·å–æç¤ºã€‚'
        });
    }

    if (stats.completed_exercises > 0 && stats.average_score > 85) {
        insights.push({
            type: 'success',
            icon: 'fas fa-star',
            title: 'ä¼˜ç§€è¡¨ç°',
            message: 'æ‚¨çš„å­¦ä¹ è¡¨ç°éå¸¸å‡ºè‰²ï¼ç»§ç»­ä¿æŒè¿™ç§å­¦ä¹ æ€åº¦ã€‚'
        });
    }

    if (stats.total_time_spent < 3600) { // å°‘äº1å°æ—¶
        insights.push({
            type: 'info',
            icon: 'fas fa-clock',
            title: 'å¢åŠ å­¦ä¹ æ—¶é—´',
            message: 'é€‚å½“å¢åŠ å­¦ä¹ æ—¶é—´å¯ä»¥å¸®åŠ©æ‚¨æ›´æ·±å…¥åœ°ç†è§£æ¦‚å¿µã€‚'
        });
    }

    if (insights.length === 0) {
        insights.push({
            type: 'success',
            icon: 'fas fa-check-circle',
            title: 'å­¦ä¹ çŠ¶æ€è‰¯å¥½',
            message: 'æ‚¨çš„å­¦ä¹ è¿›åº¦å’Œè¡¨ç°éƒ½éå¸¸å‡è¡¡ã€‚ç»§ç»­ä¿æŒï¼'
        });
    }

    const insightsHtml = insights.map(insight => `
        <div class="insight-card alert alert-${insight.type}">
            <div class="d-flex align-items-start">
                <i class="${insight.icon} me-3 mt-1"></i>
                <div>
                    <h6 class="mb-1">${insight.title}</h6>
                    <p class="mb-0 small">${insight.message}</p>
                </div>
            </div>
        </div>
    `).join('');

    container.innerHTML = insightsHtml;
}

// æ¸²æŸ“æ’è¡Œæ¦œ
function renderLeaderboards(leaderboard) {
    const overallContainer = document.getElementById('leaderboardOverall');
    const weeklyContainer = document.getElementById('leaderboardWeekly');

    // æ€»ä½“æ’è¡Œæ¦œ
    const overallHtml = leaderboard.slice(0, 10).map((item, index) => `
        <div class="leaderboard-item ${item.username === '{{ current_user.username }}' ? 'current-user' : ''}">
            <div class="rank-badge rank-${index < 3 ? (index + 1) : 'other'}">
                ${index + 1}
            </div>
            <div class="flex-grow-1">
                <strong>${item.username}</strong>
                <br>
                <small class="text-muted">${Math.round(item.total_score)} åˆ† â€¢ ${item.correct_submissions}/${item.total_submissions} é¢˜æ­£ç¡®</small>
            </div>
        </div>
    `).join('');

    overallContainer.innerHTML = overallHtml;

    // æœ¬å‘¨æ’è¡Œæ¦œï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦å•ç‹¬çš„APIï¼‰
    const weeklyHtml = leaderboard.slice(0, 10).map((item, index) => `
        <div class="leaderboard-item ${item.username === '{{ current_user.username }}' ? 'current-user' : ''}">
            <div class="rank-badge rank-${index < 3 ? (index + 1) : 'other'}">
                ${index + 1}
            </div>
            <div class="flex-grow-1">
                <strong>${item.username}</strong>
                <br>
                <small class="text-muted">${Math.round(item.total_score * 0.1)} åˆ† â€¢ ${Math.round(item.correct_submissions * 0.1)} é¢˜æ­£ç¡®</small>
            </div>
        </div>
    `).join('');

    weeklyContainer.innerHTML = weeklyHtml;
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    const container = document.getElementById('statsCards');
    container.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${message}
            </div>
        </div>
    `;
}
</script>
{% endblock %}
