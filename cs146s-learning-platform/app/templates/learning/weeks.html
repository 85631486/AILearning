{% extends "base.html" %}

{% block title %}å­¦ä¹ å‘¨æ¬¡ - CS146S åœ¨çº¿å­¦ä¹ å¹³å°{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">å­¦ä¹ ä»ªè¡¨æ¿</a></li>
                <li class="breadcrumb-item active">å­¦ä¹ å‘¨æ¬¡</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-calendar-week"></i> å­¦ä¹ å‘¨æ¬¡</h2>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" onclick="setViewMode('grid')">
                    <i class="fas fa-th"></i> ç½‘æ ¼è§†å›¾
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="setViewMode('list')">
                    <i class="fas fa-list"></i> åˆ—è¡¨è§†å›¾
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å­¦ä¹ è¿›åº¦æ¦‚è§ˆ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="progress-circle" data-progress="0" id="overallProgress">
                            <div class="progress-text">
                                <span class="progress-value">0%</span>
                                <br>
                                <small class="text-muted">æ€»ä½“è¿›åº¦</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-primary mb-1" id="completedWeeks">0</h4>
                        <small class="text-muted">å·²å®Œæˆå‘¨æ¬¡</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-success mb-1" id="totalScore">0</h4>
                        <small class="text-muted">æ€»å¾—åˆ†</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-info mb-1" id="nextMilestone">Week 1</h4>
                        <small class="text-muted">ä¸‹ä¸€é‡Œç¨‹ç¢‘</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å‘¨æ¬¡åˆ—è¡¨ -->
<div class="row" id="weeksContainer">
    <!-- å‘¨æ¬¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
</div>

<!-- å­¦ä¹ å»ºè®® -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb"></i> å­¦ä¹ å»ºè®®</h5>
            </div>
            <div class="card-body" id="learningTips">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½å­¦ä¹ å»ºè®®ä¸­...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.progress-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: conic-gradient(#007bff 0deg, #e9ecef 0deg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    position: relative;
}

.progress-circle::before {
    content: '';
    width: 80px;
    height: 80px;
    background: white;
    border-radius: 50%;
    position: absolute;
}

.progress-text {
    position: relative;
    z-index: 1;
    font-weight: bold;
    color: #007bff;
}

.weeks-grid .week-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.weeks-grid .week-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.week-status-not-started {
    border-left: 4px solid #6c757d;
}

.week-status-in-progress {
    border-left: 4px solid #ffc107;
    background: linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(255,193,7,0.05) 100%);
}

.week-status-completed {
    border-left: 4px solid #28a745;
    background: linear-gradient(135deg, rgba(40,167,69,0.1) 0%, rgba(40,167,69,0.05) 100%);
}

.week-progress {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0;
}

.week-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #0056b3);
    transition: width 0.3s ease;
}

.exercise-count {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    color: #6c757d;
}

.difficulty-beginner { color: #28a745; }
.difficulty-intermediate { color: #ffc107; }
.difficulty-advanced { color: #dc3545; }
</style>

<script>
let currentViewMode = 'grid';
let weeksData = [];

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadWeeksData();
});

// åŠ è½½å‘¨æ¬¡æ•°æ®
function loadWeeksData() {
    Promise.all([
        fetch('/api/v1/learning/progress').then(r => r.json()),
        fetch('/api/v1/learning/weeks').then(r => r.json()),
        fetch('/api/v1/learning/stats').then(r => r.json())
    ])
    .then(([progressData, weeksData, statsData]) => {
        if (progressData.success && weeksData.success && statsData.success) {
            renderOverview(progressData.progress, statsData.stats);
            renderWeeks(weeksData.weeks, progressData.progress);
            renderLearningTips(progressData.progress, statsData.stats);
        }
    })
    .catch(error => {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        document.getElementById('weeksContainer').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•
                </div>
            </div>
        `;
    });
}

// æ¸²æŸ“æ¦‚è§ˆæ•°æ®
function renderOverview(progress, stats) {
    // æ›´æ–°æ€»ä½“è¿›åº¦
    const overallProgress = progress.overall_progress;
    document.getElementById('overallProgress').setAttribute('data-progress', overallProgress);
    document.querySelector('#overallProgress .progress-value').textContent = Math.round(overallProgress) + '%';

    // æ›´æ–°CSSå˜é‡ç”¨äºè¿›åº¦åœ†ç¯
    const progressCircle = document.getElementById('overallProgress');
    progressCircle.style.background = `conic-gradient(#007bff ${overallProgress * 3.6}deg, #e9ecef 0deg)`;

    // æ›´æ–°å…¶ä»–ç»Ÿè®¡
    document.getElementById('completedWeeks').textContent = progress.completed_weeks;
    document.getElementById('totalScore').textContent = Math.round(stats.total_score);

    // è®¡ç®—ä¸‹ä¸€é‡Œç¨‹ç¢‘
    const nextMilestone = progress.weeks.find(w => w.status !== 'completed');
    document.getElementById('nextMilestone').textContent = nextMilestone ? `Week ${nextMilestone.week_number}` : 'å…¨éƒ¨å®Œæˆ';
}

// æ¸²æŸ“å‘¨æ¬¡åˆ—è¡¨
function renderWeeks(weeks, progress) {
    const container = document.getElementById('weeksContainer');

    // åˆ›å»ºè¿›åº¦æ˜ å°„
    const progressMap = {};
    progress.weeks.forEach(p => {
        progressMap[p.week_id] = p;
    });

    const weeksHtml = weeks.map(week => {
        const weekProgress = progressMap[week.id] || {
            status: 'not_started',
            progress_percentage: 0,
            completed_exercises: 0,
            total_exercises: 0
        };

        return createWeekCard(week, weekProgress);
    }).join('');

    container.innerHTML = weeksHtml;
    container.className = `row ${currentViewMode === 'grid' ? 'weeks-grid' : 'weeks-list'}`;
}

// åˆ›å»ºå‘¨æ¬¡å¡ç‰‡
function createWeekCard(week, progress) {
    const statusClass = `week-status-${progress.status}`;
    const statusText = getStatusText(progress.status);
    const statusIcon = getStatusIcon(progress.status);

    return `
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card week-card h-100 ${statusClass}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-week text-primary"></i>
                        Week ${week.week_number}: ${week.title}
                    </h5>
                    <span class="badge ${getStatusBadgeClass(progress.status)}">
                        ${statusIcon} ${statusText}
                    </span>
                </div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text text-muted mb-3">${week.description || 'å¼€å§‹æ‚¨çš„ç¼–ç¨‹å­¦ä¹ ä¹‹æ—…'}</p>

                    <div class="week-progress">
                        <div class="week-progress-bar" style="width: ${progress.progress_percentage}%"></div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <small class="text-muted">
                            è¿›åº¦: ${Math.round(progress.progress_percentage)}%
                        </small>
                        <small class="exercise-count">
                            <i class="fas fa-code"></i>
                            ${progress.completed_exercises}/${progress.total_exercises} ç»ƒä¹ 
                        </small>
                    </div>

                    <div class="mt-auto">
                        <a href="/weeks/${week.week_number}" class="btn btn-primary w-100">
                            ${progress.status === 'not_started' ? 'å¼€å§‹å­¦ä¹ ' : 'ç»§ç»­å­¦ä¹ '}
                            <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(status) {
    switch (status) {
        case 'not_started': return 'æœªå¼€å§‹';
        case 'in_progress': return 'è¿›è¡Œä¸­';
        case 'completed': return 'å·²å®Œæˆ';
        default: return 'æœªçŸ¥';
    }
}

// è·å–çŠ¶æ€å›¾æ ‡
function getStatusIcon(status) {
    switch (status) {
        case 'not_started': return 'â³';
        case 'in_progress': return 'ğŸ”„';
        case 'completed': return 'âœ…';
        default: return 'â“';
    }
}

// è·å–çŠ¶æ€å¾½ç« æ ·å¼
function getStatusBadgeClass(status) {
    switch (status) {
        case 'not_started': return 'bg-secondary';
        case 'in_progress': return 'bg-warning text-dark';
        case 'completed': return 'bg-success';
        default: return 'bg-secondary';
    }
}

// è®¾ç½®è§†å›¾æ¨¡å¼
function setViewMode(mode) {
    currentViewMode = mode;

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });

    if (mode === 'grid') {
        document.querySelector('[onclick="setViewMode(\'grid\')"]').classList.add('active');
    } else {
        document.querySelector('[onclick="setViewMode(\'list\')"]').classList.add('active');
    }

    // é‡æ–°æ¸²æŸ“å‘¨æ¬¡åˆ—è¡¨
    if (weeksData.length > 0) {
        renderWeeks(weeksData, window.currentProgress);
    }
}

// æ¸²æŸ“å­¦ä¹ å»ºè®®
function renderLearningTips(progress, stats) {
    const tipsContainer = document.getElementById('learningTips');

    let tips = [];

    // åŸºäºè¿›åº¦ç”Ÿæˆå»ºè®®
    if (progress.overall_progress === 0) {
        tips.push({
            icon: 'ğŸš€',
            title: 'å¼€å§‹å­¦ä¹ ä¹‹æ—…',
            message: 'ä»ç¬¬ä¸€å‘¨å¼€å§‹ï¼Œé€æ­¥æŒæ¡Pythonç¼–ç¨‹åŸºç¡€ã€‚',
            action: { text: 'å¼€å§‹Week 1', url: '/weeks/1' }
        });
    }

    if (stats.streak_days === 0 && progress.completed_weeks > 0) {
        tips.push({
            icon: 'ğŸ”¥',
            title: 'ä¿æŒå­¦ä¹ è¿ç»­æ€§',
            message: 'è¿ç»­å­¦ä¹ å¯ä»¥å¸®åŠ©æ‚¨æ›´å¥½åœ°æŒæ¡çŸ¥è¯†ï¼Œå½¢æˆè‰¯å¥½çš„å­¦ä¹ ä¹ æƒ¯ã€‚',
            action: { text: 'ç»§ç»­å­¦ä¹ ', url: '/weeks' }
        });
    }

    if (stats.accuracy_rate < 70 && stats.total_submissions > 5) {
        tips.push({
            icon: 'ğŸ¯',
            title: 'æé«˜å‡†ç¡®ç‡',
            message: 'å°è¯•ä»”ç»†é˜…è¯»é¢˜ç›®è¦æ±‚ï¼Œä½¿ç”¨AIåŠ©æ‰‹è·å–æç¤ºã€‚',
            action: { text: 'å¯»æ±‚å¸®åŠ©', url: '/ai-assistant' }
        });
    }

    if (stats.completed_exercises > 10 && stats.average_score > 80) {
        tips.push({
            icon: 'â­',
            title: 'ä¼˜ç§€è¡¨ç°',
            message: 'æ‚¨çš„å­¦ä¹ è¿›åº¦éå¸¸å‡ºè‰²ï¼ç»§ç»­ä¿æŒã€‚',
            type: 'positive'
        });
    }

    if (tips.length === 0) {
        tips.push({
            icon: 'ğŸ“š',
            title: 'æŒç»­å­¦ä¹ ',
            message: 'ä¿æŒè§„å¾‹çš„å­¦ä¹ èŠ‚å¥ï¼Œé€æ­¥æå‡ç¼–ç¨‹æŠ€èƒ½ã€‚',
            type: 'neutral'
        });
    }

    const tipsHtml = tips.map(tip => `
        <div class="alert ${tip.type === 'positive' ? 'alert-success' : tip.type === 'warning' ? 'alert-warning' : 'alert-info'} d-flex align-items-start">
            <div class="me-3 fs-4">${tip.icon}</div>
            <div class="flex-grow-1">
                <h6 class="alert-heading mb-1">${tip.title}</h6>
                <p class="mb-2">${tip.message}</p>
                ${tip.action ? `<a href="${tip.action.url}" class="btn btn-sm btn-outline-primary">${tip.action.text}</a>` : ''}
            </div>
        </div>
    `).join('');

    tipsContainer.innerHTML = tipsHtml;
}
</script>
{% endblock %}
