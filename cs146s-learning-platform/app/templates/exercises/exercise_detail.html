{% extends "base.html" %}

{% block title %}{{ exercise.title }} - CS146S åœ¨çº¿å­¦ä¹ å¹³å°{% endblock %}

{% block content %}
<div class="row" data-exercise-id="{{ exercise.id }}">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.weeks') }}">è¯¾ç¨‹å­¦ä¹ </a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('main.week_detail', week_number=exercise.week.week_number) }}">Week {{ exercise.week.week_number }}</a></li>
                <li class="breadcrumb-item active">{{ exercise.title }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- ç»ƒä¹ ä¿¡æ¯ -->
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-code"></i> {{ exercise.title }}
                    <span class="badge bg-{{ 'primary' if exercise.difficulty == 'beginner' else 'warning' if exercise.difficulty == 'intermediate' else 'danger' }} ms-2">
                        {{ exercise.difficulty }}
                    </span>
                </h4>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>ç±»å‹ï¼š</strong>{{ exercise.exercise_type }}
                    </div>
                    <div class="col-md-6">
                        <strong>åˆ†æ•°ï¼š</strong>{{ exercise.points }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>æ—¶é—´é™åˆ¶ï¼š</strong>{{ exercise.time_limit }} åˆ†é’Ÿ
                    </div>
                    <div class="col-md-6">
                        <strong>éš¾åº¦ï¼š</strong>{{ exercise.difficulty }}
                    </div>
                </div>
                <hr>
                <div class="exercise-description">
                    <h5>ç»ƒä¹ æè¿°</h5>
                    <div class="content">
                        {% if exercise.description %}
                            {{ exercise.description | markdown }}
                        {% else %}
                            <p class="text-muted">æš‚æ— æè¿°</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»£ç ç¼–è¾‘å™¨ -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> ä»£ç ç¼–è¾‘å™¨
                    </h5>
                    <div id="autosave-indicator" class="autosave-indicator">
                        <!-- Autosave status will be shown here -->
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Editor Toolbar -->
                <div class="editor-toolbar mb-3">
                    <div class="toolbar-group">
                        <button id="runCodeBtn" class="toolbar-button success">
                            <i class="fas fa-play"></i> è¿è¡Œä»£ç 
                        </button>
                        <button id="formatCodeBtn" class="toolbar-button primary">
                            <i class="fas fa-magic"></i> æ ¼å¼åŒ–
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button id="submitBtn" class="toolbar-button primary">
                            <i class="fas fa-paper-plane"></i> æäº¤ç­”æ¡ˆ
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <div class="editor-indicators">
                            <span id="theme-indicator" class="editor-indicator" title="ä¸»é¢˜">â˜€ï¸</span>
                            <span id="line-numbers-indicator" class="editor-indicator" title="è¡Œå·">ğŸ”¢</span>
                        </div>
                        <div class="settings-dropdown">
                            <button id="editorSettingsBtn" class="toolbar-button">
                                <i class="fas fa-cog"></i> è®¾ç½®
                            </button>
                            <div id="settings-menu" class="settings-menu">
                                <div class="menu-header">ç¼–è¾‘å™¨è®¾ç½®</div>
                                <button class="menu-item" onclick="exerciseEditor.toggleTheme()">
                                    <i class="fas fa-moon"></i> <span id="theme-text">åˆ‡æ¢åˆ°æ·±è‰²ä¸»é¢˜</span>
                                </button>
                                <button class="menu-item" onclick="exerciseEditor.toggleLineNumbers()">
                                    <i class="fas fa-list-ol"></i> <span id="line-numbers-text">éšè—è¡Œå·</span>
                                </button>
                                <div class="menu-divider"></div>
                                <div class="menu-header">åˆ¶è¡¨ç¬¦è®¾ç½®</div>
                                <button class="menu-item" onclick="exerciseEditor.setTabSize(2)">
                                    <i class="fas fa-indent"></i> åˆ¶è¡¨ç¬¦: 2ä¸ªç©ºæ ¼
                                </button>
                                <button class="menu-item" onclick="exerciseEditor.setTabSize(4)">
                                    <i class="fas fa-indent"></i> åˆ¶è¡¨ç¬¦: 4ä¸ªç©ºæ ¼
                                </button>
                                <div class="menu-divider"></div>
                                <div class="menu-header">é”®ç›˜å¿«æ·é”®</div>
                                <button class="menu-item" onclick="exerciseEditor.showKeyboardShortcuts()">
                                    <i class="fas fa-keyboard"></i> æ˜¾ç¤ºæ‰€æœ‰å¿«æ·é”®
                                </button>
                                <div class="menu-item" style="cursor: default; padding: 0.5rem 1rem;">
                                    <small style="color: #6c757d;">
                                        Ctrl+Enter: è¿è¡Œä»£ç <br>
                                        Ctrl+S: ä¿å­˜ä»£ç <br>
                                        Ctrl+Shift+F: æ ¼å¼åŒ–<br>
                                        Ctrl+/: æ³¨é‡Šåˆ‡æ¢<br>
                                        Ctrl+Shift+T: åˆ‡æ¢ä¸»é¢˜<br>
                                        Ctrl+Shift+L: åˆ‡æ¢è¡Œå·
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monaco Editor Container -->
                <div class="editor-container">
                    <div id="editor-container" style="height: 400px;"></div>
                </div>

                <!-- Hidden initial code for editor -->
                <script id="initial-code" type="text/plain">{{ exercise.initial_code | default('# è¯·åœ¨è¿™é‡Œç¼–å†™ä»£ç \nprint("Hello World!")') }}</script>
            </div>
        </div>

        <!-- æ‰§è¡Œç»“æœ -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="output-header">
                    <div class="output-tabs">
                        <button class="output-tab active" onclick="switchOutputTab('all')">
                            <i class="fas fa-terminal"></i> å…¨éƒ¨è¾“å‡º
                        </button>
                        <button class="output-tab" onclick="switchOutputTab('stdout')">
                            <i class="fas fa-check-circle"></i> æ ‡å‡†è¾“å‡º
                        </button>
                        <button class="output-tab" onclick="switchOutputTab('stderr')">
                            <i class="fas fa-exclamation-triangle"></i> é”™è¯¯è¾“å‡º
                        </button>
                    </div>
                    <div class="output-actions">
                        <button class="toolbar-button" onclick="copyOutput()" title="å¤åˆ¶è¾“å‡º">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="toolbar-button" onclick="clearOutput()" title="æ¸…é™¤è¾“å‡º">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="output-panel" class="output-panel">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> è¯·å…ˆè¿è¡Œä»£ç æŸ¥çœ‹ç»“æœ
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»£ç æ£€æŸ¥é¢æ¿ -->
        <div id="lint-panel" class="lint-panel">
            <div id="lint-header" class="lint-header">
                <div class="lint-toggle">
                    <i class="fas fa-chevron-down"></i>
                    <span>ä»£ç æ£€æŸ¥</span>
                    <span id="lint-count" class="lint-count">0</span>
                </div>
                <div class="lint-actions">
                    <button class="toolbar-button" onclick="exerciseEditor.lintManager.scheduleCheck()" title="é‡æ–°æ£€æŸ¥">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="toolbar-button" onclick="clearLintIssues()" title="æ¸…é™¤é—®é¢˜">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="lint-content" class="lint-content">
                <div class="text-muted p-3">æ­£åœ¨æ£€æŸ¥ä»£ç ...</div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- ç»ƒä¹ æç¤º -->
        {% if exercise.hints %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb"></i> æç¤º
                </h5>
            </div>
            <div class="card-body">
                <div id="hints-content">
                    {{ exercise.hints | markdown }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- AIåŠ©æ‰‹ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-robot"></i> AIåŠ©æ‰‹
                </h5>
            </div>
            <div class="card-body">
                <button id="explainCodeBtn" class="btn btn-outline-info btn-sm mb-2 w-100">
                    <i class="fas fa-question-circle"></i> è§£é‡Šä»£ç 
                </button>
                <button id="debugCodeBtn" class="btn btn-outline-warning btn-sm mb-2 w-100">
                    <i class="fas fa-bug"></i> è°ƒè¯•ä»£ç 
                </button>
                <button id="getHintBtn" class="btn btn-outline-success btn-sm w-100">
                    <i class="fas fa-lightbulb"></i> è·å–æç¤º
                </button>
            </div>
        </div>

        <!-- å­¦ä¹ è¿›åº¦ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line"></i> å­¦ä¹ è¿›åº¦
                </h5>
            </div>
            <div class="card-body">
                <div id="progress-info">
                    <p class="text-muted">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- æäº¤å†å² -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history"></i> æäº¤å†å²
                </h5>
            </div>
            <div class="card-body">
                <div id="submission-history">
                    <p class="text-muted">æš‚æ— æäº¤è®°å½•</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AIå¯¹è¯æ¨¡æ€æ¡† -->
<div class="modal fade" id="aiModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiModalTitle">AIåŠ©æ‰‹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="ai-response" class="text-muted">
                    æ­£åœ¨æ€è€ƒä¸­...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Editor Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">

<!-- Monaco Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

<!-- Exercise Editor Script -->
<script src="{{ url_for('static', filename='js/exercise-editor.js') }}"></script>

<script>
// ç®€å•çš„è¾…åŠ©å‡½æ•°
function switchOutputTab(tab) {
    // åˆ‡æ¢è¾“å‡ºæ ‡ç­¾é¡µçš„å®ç°
    const tabs = document.querySelectorAll('.output-tab');
    const contents = document.querySelectorAll('.output-content');

    tabs.forEach(t => t.classList.remove('active'));
    contents.forEach(c => c.style.display = 'none');

    document.querySelector(`[onclick="switchOutputTab('${tab}')"]`).classList.add('active');

    if (tab === 'stdout') {
        document.querySelector('.stdout').style.display = 'block';
    } else if (tab === 'stderr') {
        document.querySelector('.stderr').style.display = 'block';
    } else {
        contents.forEach(c => c.style.display = 'block');
    }
}

function copyOutput() {
    const output = document.querySelector('.output-content pre');
    if (output) {
        navigator.clipboard.writeText(output.textContent).then(() => {
            // å¯ä»¥æ·»åŠ ä¸€ä¸ªä¸´æ—¶çš„"å·²å¤åˆ¶"æç¤º
            console.log('Output copied to clipboard');
        });
    }
}

function clearOutput() {
    const outputPanel = document.getElementById('output-panel');
    outputPanel.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> è¾“å‡ºå·²æ¸…é™¤ï¼Œè¯·é‡æ–°è¿è¡Œä»£ç 
        </div>
    `;
}

function clearLintIssues() {
    if (window.exerciseEditor && window.exerciseEditor.lintManager) {
        window.exerciseEditor.lintManager.issues = [];
        window.exerciseEditor.lintManager.updateDecorations();
        window.exerciseEditor.lintManager.updatePanel();
    }
}

function toggleTheme() {
    const currentTheme = localStorage.getItem('editor-theme') || 'vs-light';
    const newTheme = currentTheme === 'vs-light' ? 'vs-dark' : 'vs-light';
    localStorage.setItem('editor-theme', newTheme);

    if (window.exerciseEditor && window.exerciseEditor.editor) {
        window.exerciseEditor.editor.updateOptions({ theme: newTheme });
    }
}

function toggleLineNumbers() {
    const current = localStorage.getItem('editor-line-numbers') !== 'false';
    const newValue = !current;
    localStorage.setItem('editor-line-numbers', newValue);

    if (window.exerciseEditor && window.exerciseEditor.editor) {
        window.exerciseEditor.editor.updateOptions({
            lineNumbers: newValue ? 'on' : 'off'
        });
    }
}

// ç¡®ä¿exerciseEditoråœ¨å…¨å±€ä½œç”¨åŸŸä¸­å¯ç”¨
window.exerciseEditor = null;

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ç»ƒä¹ è¯¦æƒ…é¡µé¢å·²åŠ è½½ - å¢å¼ºç‰ˆç¼–è¾‘å™¨');

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶å…³é—­è®¾ç½®èœå•
    document.addEventListener('click', function(e) {
        const settingsMenu = document.getElementById('settings-menu');
        const settingsBtn = document.getElementById('editorSettingsBtn');

        if (settingsMenu && settingsBtn &&
            !settingsBtn.contains(e.target) &&
            !settingsMenu.contains(e.target)) {
            settingsMenu.classList.remove('show');
        }
    });
});
</script>
{% endblock %}
